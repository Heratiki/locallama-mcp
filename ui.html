<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalLama MCP Interface</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .model-card {
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .model-card:hover {
      transform: translateY(-2px);
    }
    
    .status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
    }
    
    .status-connecting { background-color: #ffc107; }
    .status-connected { background-color: #28a745; }
    .status-error { background-color: #dc3545; }
    
    .benchmark-button {
      margin: 5px;
      min-width: 120px;
    }
    
    #modelSearch {
      margin-bottom: 15px;
    }
    
    .provider-section {
      margin-bottom: 30px;
    }
    
    .model-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .tab-content {
      padding: 20px;
      background: white;
      border-radius: 0 0 5px 5px;
      border: 1px solid #dee2e6;
      border-top: none;
    }
    
    .benchmark-results {
      margin-top: 20px;
    }
    
    .progress-bar {
      height: 25px;
    }
    
    .model-select-container {
      margin-bottom: 20px;
    }
    
    .result-card {
      margin-bottom: 15px;
    }
    
    .benchmark-task {
      margin-bottom: 25px;
      border-left: 4px solid #007bff;
      padding-left: 15px;
    }
    
    .code-output {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .metric-label {
      font-weight: bold;
      display: inline-block;
      width: 120px;
    }
    
    .metric-value {
      font-weight: bold;
      color: #007bff;
    }
    
    .provider-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-left: 8px;
      background-color: #e9ecef;
    }
    
    .thinking-toggle {
      cursor: pointer;
      color: #6c757d;
      text-decoration: underline;
      margin-top: 5px;
      display: inline-block;
    }
    
    .thinking-content {
      background-color: #f0f8ff;
      padding: 10px;
      border-radius: 5px;
      margin-top: 5px;
      font-style: italic;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">LocalLama MCP Benchmark Interface</h1>
    
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="benchmarks-tab" data-bs-toggle="tab" href="#benchmarks" role="tab">Benchmark Results</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="jobs-tab" data-bs-toggle="tab" href="#jobs" role="tab">Jobs</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="benchmarks" role="tabpanel">
        <div class="row mb-3 mt-3">
          <div class="col">
            <h3>Model Benchmark Results</h3>
            <p>Select a model to view its benchmark results or run new benchmarks.</p>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" onclick="runAllBenchmarks()">
              Run All Benchmarks
            </button>
          </div>
        </div>
        
        <div class="model-select-container">
          <label for="benchmarkModelSelect" class="form-label">Select Model:</label>
          <div class="input-group">
            <select class="form-select" id="benchmarkModelSelect" onchange="loadModelBenchmarks()">
              <option value="" selected>Choose a model...</option>
              <!-- Models will be loaded here -->
            </select>
            <button class="btn btn-outline-primary" type="button" id="filterToggle" onclick="toggleProviderFilter()">
              Filter: All
            </button>
          </div>
        </div>
        
        <div id="benchmarkResults" class="benchmark-results">
          <!-- Results will appear here -->
          <div class="alert alert-info">
            Select a model to view its benchmark results
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="jobs" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header">
            <h5 class="mb-0">Active Jobs</h5>
          </div>
          <div class="card-body">
            <div id="jobsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="status-indicator" class="status-indicator status-connecting">Connecting...</div>
  
  <!-- Benchmark modal -->
  <div class="modal fade" id="benchmarkModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Benchmarking in Progress</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="benchmarkModalText">Running benchmark for <span id="benchmarkModelName"></span>...</p>
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let ws;
    let benchmarkedModels = [];
    let currentFilter = 'all';
    let benchmarkResults = {};
    let benchmarkModal;
    let jobRefreshInterval;
    let isBenchmarking = false;

    async function initializeWebSocket() {
      try {
        // First fetch the WebSocket port from the API
        const response = await fetch('/ws-port');
        const data = await response.json();
        const wsPort = data.port;
        
        // Use the dynamic port from the server
        ws = new WebSocket(`ws://localhost:${wsPort}`);
        const statusIndicator = document.getElementById('status-indicator');

        ws.addEventListener('open', () => {
          console.log(`WebSocket connection established on port ${wsPort}`);
          statusIndicator.textContent = 'Connected';
          statusIndicator.className = 'status-indicator status-connected';
          // Request initial data
          fetchBenchmarkedModels();
          fetchActiveJobs();
        });

        ws.addEventListener('error', (error) => {
          console.error('WebSocket error:', error);
          statusIndicator.textContent = 'Error';
          statusIndicator.className = 'status-indicator status-error';
        });

        ws.addEventListener('close', () => {
          console.warn('WebSocket connection closed');
          statusIndicator.textContent = 'Disconnected';
          statusIndicator.className = 'status-indicator status-error';
        });

        ws.addEventListener('message', handleWebSocketMessage);
      } catch (error) {
        console.error('WebSocket initialization error:', error);
      }
    }

    function handleWebSocketMessage(event) {
      try {
        console.log('Received WebSocket message:', event.data);
        const message = JSON.parse(event.data);
        
        // Check for RPC response format (for legacy support)
        if (message.jsonrpc === '2.0' && message.result) {
          console.log('Received RPC response:', message);
          
          // Check if this is a model list response
          if (message.result && Array.isArray(message.result.models)) {
            benchmarkedModels = message.result.models;
            populateModelSelect();
            return;
          }
          
          // Check if this is a benchmark result response
          if (message.result && message.result.modelId) {
            benchmarkResults = message.result.data;
            displayBenchmarkResults(message.result.modelId);
            
            // Reset benchmarking state when results come back
            isBenchmarking = false;
            
            // Close modal if it's open
            if (benchmarkModal && benchmarkModal._isShown) {
              benchmarkModal.hide();
            }
            return;
          }
          
          // Check if this is a benchmark completion notification
          if (message.result && message.result.status === 'completed' && message.result.modelId) {
            // Reset benchmarking state
            isBenchmarking = false;
            
            // Close modal if it's open
            if (benchmarkModal && benchmarkModal._isShown) {
              benchmarkModal.hide();
            }
            
            // Refresh data for the specific model
            fetchModelBenchmarks(message.result.modelId);
            return;
          }
          
          // Check if this is a jobs response
          if (message.result && Array.isArray(message.result.jobs)) {
            displayActiveJobs(message.result.jobs);
            return;
          }
        }
        
        // Check for error responses that might indicate benchmark failure
        if (message.jsonrpc === '2.0' && message.error) {
          console.error('RPC error:', message.error);
          // Reset benchmarking state on error
          isBenchmarking = false;
          
          if (benchmarkModal && benchmarkModal._isShown) {
            benchmarkModal.hide();
          }
          
          alert(`Error: ${message.error.message || 'Benchmark failed'}`);
          return;
        }
        
        // Handle structured message types (new format)
        if (message.type === 'benchmarkedModels') {
          console.log('Received benchmarked models:', message.models);
          benchmarkedModels = message.models;
          populateModelSelect();
        } else if (message.type === 'benchmarkResults') {
          benchmarkResults = message.results;
          displayBenchmarkResults(message.modelId);
          
          // Reset benchmarking state
          isBenchmarking = false;
          
          // Close modal if it's open
          if (benchmarkModal && benchmarkModal._isShown) {
            benchmarkModal.hide();
          }
        } else if (message.type === 'activeJobs') {
          displayActiveJobs(message.jobs);
        } else if (message.type === 'benchmarkStarted') {
          showBenchmarkModal(message.modelId);
        } else if (message.type === 'benchmarkCompleted') {
          // Reset benchmarking state
          isBenchmarking = false;
          
          if (benchmarkModal && benchmarkModal._isShown) {
            benchmarkModal.hide();
          }
          fetchBenchmarkedModels();
          fetchModelBenchmarks(message.modelId);
        } else {
          console.log('Unhandled message type:', message);
        }
      } catch (error) {
        console.error('Error processing message:', error);
        // Reset benchmarking state on error
        isBenchmarking = false;
      }
    }

    function fetchBenchmarkedModels() {
      sendCommand('getBenchmarkedModels');
    }

    function fetchModelBenchmarks(modelId) {
      sendCommand(`getModelBenchmarks ${modelId}`);
    }

    function fetchActiveJobs() {
      sendCommand('getActiveJobs');
    }

    function populateModelSelect() {
      const select = document.getElementById('benchmarkModelSelect');
      
      // Clear current options except the first one
      while (select.options.length > 1) {
        select.options.remove(1);
      }
      
      // Filter models based on current filter
      let filteredModels = benchmarkedModels;
      if (currentFilter !== 'all') {
        filteredModels = benchmarkedModels.filter(model => model.provider === currentFilter);
      }
      
      // Sort models by provider then name
      filteredModels.sort((a, b) => {
        if (a.provider !== b.provider) {
          return a.provider.localeCompare(b.provider);
        }
        return a.name.localeCompare(b.name);
      });
      
      // Add options for each model
      filteredModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.text = `${model.name} (${model.provider})`;
        option.dataset.provider = model.provider;
        select.add(option);
      });
    }

    function toggleProviderFilter() {
      const filterButton = document.getElementById('filterToggle');
      const providers = [...new Set(benchmarkedModels.map(model => model.provider))];
      
      // Find the next filter in the cycle
      let nextFilterIndex = 0;
      if (currentFilter === 'all') {
        nextFilterIndex = 0;
      } else {
        nextFilterIndex = providers.indexOf(currentFilter) + 1;
        if (nextFilterIndex >= providers.length) {
          nextFilterIndex = -1;  // Back to 'all'
        }
      }
      
      // Set the new filter
      currentFilter = nextFilterIndex === -1 ? 'all' : providers[nextFilterIndex];
      
      // Update the button text
      filterButton.textContent = `Filter: ${currentFilter === 'all' ? 'All' : currentFilter}`;
      
      // Re-populate the model select
      populateModelSelect();
    }

    function loadModelBenchmarks() {
      const select = document.getElementById('benchmarkModelSelect');
      const modelId = select.value;
      
      if (!modelId) {
        document.getElementById('benchmarkResults').innerHTML = `
          <div class="alert alert-info">
            Select a model to view its benchmark results
          </div>
        `;
        return;
      }
      
      fetchModelBenchmarks(modelId);
    }

    function displayBenchmarkResults(modelId) {
      const resultsContainer = document.getElementById('benchmarkResults');
      const results = benchmarkResults;
      
      if (!results || Object.keys(results).length === 0) {
        resultsContainer.innerHTML = `
          <div class="alert alert-warning">
            No benchmark results found for this model
          </div>
        `;
        return;
      }
      
      // Get model info
      const modelInfo = benchmarkedModels.find(m => m.id === modelId);
      if (!modelInfo) {
        return;
      }
      
      // Build the results display
      let html = `
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">${modelInfo.name} 
              <span class="provider-badge">${modelInfo.provider}</span>
            </h4>
            <button class="btn btn-primary" onclick="rebenchmarkModel('${modelId}')">
              Re-benchmark Model
            </button>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <div><span class="metric-label">Success Rate:</span> <span class="metric-value">${(results.successRate * 100).toFixed(1)}%</span></div>
              </div>
              <div class="col-md-4">
                <div><span class="metric-label">Quality Score:</span> <span class="metric-value">${results.qualityScore.toFixed(2)}</span></div>
              </div>
              <div class="col-md-4">
                <div><span class="metric-label">Avg Response:</span> <span class="metric-value">${results.avgResponseTime.toFixed(0)}ms</span></div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <div><span class="metric-label">Complexity:</span> <span class="metric-value">${results.complexityScore.toFixed(2)}</span></div>
              </div>
              <div class="col-md-4">
                <div><span class="metric-label">Benchmark Count:</span> <span class="metric-value">${results.benchmarkCount}</span></div>
              </div>
              <div class="col-md-4">
                <div><span class="metric-label">Last Benchmark:</span> <span class="metric-value">${new Date(results.lastBenchmarked).toLocaleDateString()}</span></div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add task results if available
      if (results.tasks && results.tasks.length > 0) {
        html += `<h4>Benchmark Tasks</h4>`;
        
        results.tasks.forEach((task, index) => {
          const hasThinking = task.output && (
            task.output.includes('<thinking>') || 
            task.output.includes('[thinking]') || 
            task.output.includes('<|thinking|>')
          );
          
          let cleanOutput = task.output || '';
          let thinkingOutput = '';
          
          if (hasThinking) {
            // Extract thinking content
            const thinkingMatches = cleanOutput.match(/<thinking>([\s\S]*?)<\/thinking>/);
            if (thinkingMatches) {
              thinkingOutput = thinkingMatches[1];
              cleanOutput = cleanOutput.replace(/<thinking>[\s\S]*?<\/thinking>/g, '');
            }
            
            // Handle other thinking formats
            const bracketThinkingMatches = cleanOutput.match(/\[thinking\]([\\s\S]*?)\[\/thinking\]/i);
            if (bracketThinkingMatches) {
              thinkingOutput = bracketThinkingMatches[1];
              cleanOutput = cleanOutput.replace(/\[thinking\][\s\S]*?\[\/thinking\]/gi, '');
            }
          }
          
          html += `
            <div class="benchmark-task">
              <h5>Task ${index + 1}: ${task.name}</h5>
              <div class="task-prompt mb-2">
                <strong>Prompt:</strong> ${task.prompt}
              </div>
              <div class="row mb-3">
                <div class="col-md-3">
                  <div><span class="metric-label">Success:</span> <span class="metric-value">${task.success ? 'Yes' : 'No'}</span></div>
                </div>
                <div class="col-md-3">
                  <div><span class="metric-label">Quality:</span> <span class="metric-value">${task.qualityScore.toFixed(2)}</span></div>
                </div>
                <div class="col-md-3">
                  <div><span class="metric-label">Time:</span> <span class="metric-value">${task.responseTime}ms</span></div>
                </div>
              </div>
              <div class="output-section">
                <strong>Output:</strong>
                <div class="code-output">${cleanOutput}</div>
                ${hasThinking ? `
                  <a class="thinking-toggle" onclick="toggleThinking('thinking-${index}')">
                    Show/hide thinking process
                  </a>
                  <div id="thinking-${index}" class="thinking-content">
                    ${thinkingOutput}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
      }
      
      resultsContainer.innerHTML = html;
    }

    function toggleThinking(id) {
      const element = document.getElementById(id);
      if (element.style.display === 'block') {
        element.style.display = 'none';
      } else {
        element.style.display = 'block';
      }
    }

    function displayActiveJobs(jobs) {
      const jobsList = document.getElementById('jobsList');
      
      if (!jobs || jobs.length === 0) {
        jobsList.innerHTML = '<div class="alert alert-info">No active jobs</div>';
        return;
      }
      
      let html = '';
      jobs.forEach(job => {
        let statusBadge = '';
        switch (job.status) {
          case 'running':
            statusBadge = '<span class="badge bg-primary">Running</span>';
            break;
          case 'completed':
            statusBadge = '<span class="badge bg-success">Completed</span>';
            break;
          case 'failed':
            statusBadge = '<span class="badge bg-danger">Failed</span>';
            break;
          default:
            statusBadge = `<span class="badge bg-secondary">${job.status}</span>`;
        }
        
        html += `
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <h5 class="card-title">${job.type}</h5>
                ${statusBadge}
              </div>
              <p class="card-text">${job.description}</p>
              <div class="text-muted small">Started: ${new Date(job.startTime).toLocaleString()}</div>
            </div>
          </div>
        `;
      });
      
      jobsList.innerHTML = html;
    }

    function rebenchmarkModel(modelId) {
      if (confirm('Are you sure you want to re-benchmark this model? This may take several minutes.')) {
        // Set benchmarking state to true
        isBenchmarking = true;
        
        // Show benchmark modal immediately
        showBenchmarkModal(modelId);
        
        // Send command to server
        sendCommand(`rebenchmarkModel ${modelId}`);
      }
    }

    function runAllBenchmarks() {
      if (confirm('Are you sure you want to run benchmarks for all models? This may take a long time.')) {
        // Set benchmarking state to true
        isBenchmarking = true;
        sendCommand('runAllBenchmarks');
      }
    }

    function showBenchmarkModal(modelId) {
      const modelElement = document.getElementById('benchmarkModelName');
      const model = benchmarkedModels.find(m => m.id === modelId);
      
      if (modelElement && model) {
        modelElement.textContent = model.name;
      }
      
      // Initialize modal if it doesn't exist
      if (!benchmarkModal) {
        benchmarkModal = new bootstrap.Modal(document.getElementById('benchmarkModal'));
      }
      
      benchmarkModal.show();
    }

    function sendCommand(command) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = {
          jsonrpc: '2.0',
          id: Date.now(),
          method: 'executeCommand',
          params: { command }
        };
        ws.send(JSON.stringify(message));
      } else {
        alert('WebSocket is not connected.');
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      initializeWebSocket();
      
      // Set up refresh interval for jobs
      startJobRefreshInterval();
    });
    
    function startJobRefreshInterval() {
      // Clear any existing interval first
      if (jobRefreshInterval) {
        clearInterval(jobRefreshInterval);
      }
      
      // Set up a new interval
      jobRefreshInterval = setInterval(() => {
        // Only fetch jobs if we're not currently benchmarking
        if (!isBenchmarking) {
          fetchActiveJobs();
        }
      }, 10000); // Every 10 seconds
    }
    
    function pauseJobRefreshInterval() {
      if (jobRefreshInterval) {
        clearInterval(jobRefreshInterval);
        jobRefreshInterval = null;
      }
    }
  </script>
</body>
</html>